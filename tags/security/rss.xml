<?xml version="1.0" encoding="UTF-8"?>
<rss xmlns:atom="http://www.w3.org/2005/Atom" version="2.0">
    <channel>
      <title>Title can be filled in later - security</title>
      <link>https://blog.rnett.nz</link>
      <description></description>
      <generator>Zola</generator>
      <language>en</language>
      <atom:link href="https://blog.rnett.nz/tags/security/rss.xml" rel="self" type="application/rss+xml"/>
      <lastBuildDate>Mon, 28 Feb 2022 00:00:00 +0000</lastBuildDate>
      <item>
          <title>Slack custom emoji shinighans</title>
          <pubDate>Mon, 28 Feb 2022 00:00:00 +0000</pubDate>
          <author>Unknown</author>
          <link>https://blog.rnett.nz/posts/slack-custom-emoji/</link>
          <guid>https://blog.rnett.nz/posts/slack-custom-emoji/</guid>
          <description xml:base="https://blog.rnett.nz/posts/slack-custom-emoji/">&lt;p&gt;This will be a quick one, I swear.&lt;&#x2F;p&gt;
&lt;p&gt;I&#x27;ll start with the morale of the story:&lt;&#x2F;p&gt;
&lt;blockquote&gt;
&lt;p&gt;Some things are unexpected exhilf paths when they are working as designed.&lt;&#x2F;p&gt;
&lt;&#x2F;blockquote&gt;
&lt;p&gt;This story is about a widely used and the &quot;IRC-of-web2.js&quot;: Slack and its loved custom emojis.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;custom-emojis-how-do-they-work&quot;&gt;Custom emojis, how do they work&lt;&#x2F;h2&gt;
&lt;p&gt;Let&#x27;s all get one the same page here:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;Slack lets you to just upload little &lt;code&gt;png&lt;&#x2F;code&gt;&#x27;s&lt;&#x2F;li&gt;
&lt;li&gt;These are great for building a sense of community on a slack space&lt;&#x2F;li&gt;
&lt;li&gt;A lot of memes get uploaded&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;To dig deeper you need to use a tool that is considered illegal in some jurisdictions,
so use at your own risk: Inspect Element.&lt;&#x2F;p&gt;
&lt;p&gt;&lt;img src=&quot;&#x2F;images&#x2F;slack_custom_emoji&#x2F;inspect-element.png&quot; alt=&quot;A screenshot of Firefox development console with an image tag highlighed and a hover image of Picard faceplaming&quot; &#x2F;&gt;&lt;&#x2F;p&gt;
&lt;h2 id=&quot;slack-emojis-are-public-and-unauthenticated&quot;&gt;Slack emojis are &lt;em&gt;PUBLIC&lt;&#x2F;em&gt; and &lt;em&gt;UNAUTHENTICATED&lt;&#x2F;em&gt;&lt;&#x2F;h2&gt;
&lt;p&gt;I&#x27;ll be using a open invite Slack instance for these examples: &lt;a rel=&quot;noopener nofollow noreferrer&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;lastweekinaws.slack.com&#x2F;&quot;&gt;lastweekinaws.slack.com&lt;&#x2F;a&gt;
hosted by the &lt;a rel=&quot;noopener nofollow noreferrer&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;www.duckbillgroup.com&#x2F;&quot;&gt;Duck Bill group&lt;&#x2F;a&gt;. That Slack&#x27;s team id is: &lt;code&gt;T02N6U1DVD4&lt;&#x2F;code&gt;.&lt;&#x2F;p&gt;
&lt;blockquote&gt;
&lt;p&gt;Not a paid advertiment, just here to spread good shit posters &lt;em&gt;cough&lt;&#x2F;em&gt; &lt;a rel=&quot;noopener nofollow noreferrer&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;twitter.com&#x2F;quinnypig&quot;&gt;@quinnypig&lt;&#x2F;a&gt; &lt;em&gt;cough&lt;&#x2F;em&gt;.&lt;&#x2F;p&gt;
&lt;&#x2F;blockquote&gt;
&lt;p&gt;So, as you may know that the URLs for custom emojis are public and anyone can look at them if they have the URL.
The format of these urls look like this:&lt;&#x2F;p&gt;
&lt;p&gt;&lt;code&gt;https:&#x2F;&#x2F;emoji.slack-edge.com&#x2F;T02N6U1DVD4&#x2F;squirrel&#x2F;465f40c0e0.png&lt;&#x2F;code&gt; aka&lt;&#x2F;p&gt;
&lt;p&gt;&lt;img src=&quot;https:&#x2F;&#x2F;emoji.slack-edge.com&#x2F;T02N6U1DVD4&#x2F;squirrel&#x2F;465f40c0e0.png&quot; alt=&quot;A picture of a squirrel wearing a fedora and a suit&quot; &#x2F;&gt;&lt;&#x2F;p&gt;
&lt;p&gt;After some playing around, these urls can be expressed as &lt;code&gt;${team_id}&#x2F;${emoji_name}&#x2F;${cache_buster_hash}.png&lt;&#x2F;code&gt;&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;base url is always &lt;code&gt;https:&#x2F;&#x2F;emoji.slack-edge.com&lt;&#x2F;code&gt;&lt;&#x2F;li&gt;
&lt;li&gt;&lt;code&gt;${team_id}&lt;&#x2F;code&gt; the identifier for the slack intance&lt;&#x2F;li&gt;
&lt;li&gt;&lt;code&gt;${emoji_name}&lt;&#x2F;code&gt; is easy and quite guessable cause so many people like to recreate their last work slack in their new place, like &lt;code&gt;:falcepalm:&lt;&#x2F;code&gt;&lt;&#x2F;li&gt;
&lt;li&gt;&lt;code&gt;${cache_buster_hash}&lt;&#x2F;code&gt; is a random 10 character hex string so it can bust some caches&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;blockquote&gt;
&lt;p&gt;side note: &lt;code&gt;:squirrel:&lt;&#x2F;code&gt;  is a custom emoji on all instances &amp;amp; can be used to confirm an &lt;code&gt;team_id&lt;&#x2F;code&gt;&lt;&#x2F;p&gt;
&lt;&#x2F;blockquote&gt;
&lt;p&gt;The &lt;code&gt;${cache_buster_hash}&lt;&#x2F;code&gt; part seems to be a bit finiky. For &lt;code&gt;:squirrel:&lt;&#x2F;code&gt; it can be &lt;strong&gt;any&lt;&#x2F;strong&gt; value.
So &lt;code&gt;0000000000&lt;&#x2F;code&gt; is perfectly valid and is great to verify a &lt;code&gt;${team_id}&lt;&#x2F;code&gt;&lt;&#x2F;p&gt;
&lt;h2 id=&quot;ok-but-so-what&quot;&gt;Ok, but so what?&lt;&#x2F;h2&gt;
&lt;p&gt;Well, it is handy to know and if you ever want to spook your security team
just let them know that employee PII (photos) in the form of emojis are publicly
accessible with three easy steps:&lt;&#x2F;p&gt;
&lt;ol&gt;
&lt;li&gt;Post the emoji in question&lt;&#x2F;li&gt;
&lt;li&gt;&lt;code&gt;Right click &amp;gt; Copy Image Link&lt;&#x2F;code&gt;&lt;&#x2F;li&gt;
&lt;li&gt;Open that link in a private window &#x2F; incognito window&lt;&#x2F;li&gt;
&lt;li&gt;ü§Øüßë‚Äçüíª &lt;!-- I hope that ZWJ works everywhere --&gt;&lt;&#x2F;li&gt;
&lt;&#x2F;ol&gt;
&lt;p&gt;Though, you do need to have 3 pieces of information to get to it without it getting help from the inside.&lt;&#x2F;p&gt;
&lt;p&gt;I did take this to the Slack enterprise people once in a past job.
The response was: &quot;Working as designed&quot;.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;what-can-i-do-really-do-with-this&quot;&gt;What can I do really do with this?&lt;&#x2F;h2&gt;
&lt;p&gt;Well, not that much... you need to know the &lt;code&gt;${team_id}&lt;&#x2F;code&gt; of the slack instance you are interested in and sometimes the &lt;code&gt;${cache_buster_hash}&lt;&#x2F;code&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;That is hard if you didn&#x27;t save it somewhere before you got kicked off for spamming &lt;code&gt;:flag-ua::muscle::flag-ua:&lt;&#x2F;code&gt;&lt;&#x2F;p&gt;
&lt;p&gt;So far I have not found any unauthenticated way to get that &lt;code&gt;${team_id}&lt;&#x2F;code&gt; but the &lt;code&gt;:squirrel:&lt;&#x2F;code&gt; trick is great
to confirm a slack instance.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;conculsion-faq&quot;&gt;Conculsion &#x2F; FAQ&lt;&#x2F;h2&gt;
&lt;p&gt;Is Slack emojis good for storing important information?&lt;&#x2F;p&gt;
&lt;blockquote&gt;
&lt;p&gt;No, but this is not an invitation to start using GUID&#x27;s as emoji names nor to stop making wholesome memes of colleagues &lt;strong&gt;with their consent&lt;&#x2F;strong&gt;.&lt;&#x2F;p&gt;
&lt;&#x2F;blockquote&gt;
&lt;p&gt;So why are Slack emojis public?&lt;&#x2F;p&gt;
&lt;blockquote&gt;
&lt;p&gt;lol, no idea. Probably cause of some &lt;del&gt;legacy&lt;&#x2F;del&gt; money generating systems&lt;&#x2F;p&gt;
&lt;&#x2F;blockquote&gt;
&lt;p&gt;Should I save my companies Slack&#x27;s &lt;code&gt;${team_id}&lt;&#x2F;code&gt; before I leave so I can download all my emojis later??&lt;&#x2F;p&gt;
&lt;blockquote&gt;
&lt;p&gt;Nah. Just treat your favourte emojis like NFT&#x27;s, &lt;code&gt;right-click &amp;gt; Save Image As ...&lt;&#x2F;code&gt; them cause who knows when the server is going offline.&lt;&#x2F;p&gt;
&lt;&#x2F;blockquote&gt;
</description>
      </item>
      <item>
          <title>Budgeting your way to Admin?</title>
          <pubDate>Tue, 20 Oct 2020 00:00:00 +0000</pubDate>
          <author>Unknown</author>
          <link>https://blog.rnett.nz/posts/aws-budget-actions/</link>
          <guid>https://blog.rnett.nz/posts/aws-budget-actions/</guid>
          <description xml:base="https://blog.rnett.nz/posts/aws-budget-actions/">&lt;h1 id=&quot;how-it-started&quot;&gt;How it started&lt;&#x2F;h1&gt;
&lt;p&gt;Today I noticed a new AWS feature, you know one of the hundreds, that piqued my interest: &lt;a rel=&quot;noopener nofollow noreferrer&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;aws.amazon.com&#x2F;blogs&#x2F;aws-cost-management&#x2F;get-started-with-aws-budgets-actions&#x2F;&quot;&gt;Budget Actions&lt;&#x2F;a&gt; and the most interesting part to me is this section:&lt;&#x2F;p&gt;
&lt;blockquote&gt;
&lt;p&gt;AWS Budgets now allows you to configure actions [..] that will be applied [..] once a budget target has been exceeded.
There are three action types: &lt;strong&gt;Identity and Access Management (IAM) policies, Service Control policies (SCPs)&lt;&#x2F;strong&gt;, or target running instances (EC2 or RDS).&lt;&#x2F;p&gt;
&lt;&#x2F;blockquote&gt;
&lt;p&gt;Or in other words: if you are paying too much for AWS you can
react automagically by slapping an IAM policy or service control policy onto a thing.&lt;&#x2F;p&gt;
&lt;h1 id=&quot;why-tho&quot;&gt;why tho?&lt;&#x2F;h1&gt;
&lt;p&gt;On my first read of it I thought:&lt;&#x2F;p&gt;
&lt;blockquote&gt;
&lt;p&gt;This looks to be a new path to privilege escalation!&lt;&#x2F;p&gt;
&lt;&#x2F;blockquote&gt;
&lt;h2 id=&quot;when-would-you-even-use-this&quot;&gt;When would you even use this?&lt;&#x2F;h2&gt;
&lt;p&gt;This lends itself to some cool use cases&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;stop exporting spendy logs by denying it access to the S3 bucket (That&#x27;s what I&#x27;ll be using it for)&lt;&#x2F;li&gt;
&lt;li&gt;big corporates might like to cut costs on training accounts with a
&lt;code&gt;FinanceSayNo_DenyAll&lt;&#x2F;code&gt; SCP if you get too spendy&lt;&#x2F;li&gt;
&lt;li&gt;got a spendy vendor hosting infrastructure in your account? Just stop their
instances once they are over budget.&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;h1 id=&quot;trying-it-out&quot;&gt;Trying it out&lt;&#x2F;h1&gt;
&lt;p&gt;So as anyone would with a free service, you click about for a while.&lt;&#x2F;p&gt;
&lt;p&gt;The interesting parts I found about budgets (&amp;amp; thus budget actions) is that you have them activate
on not just cost but some service usage, like S3 or EC2 CPU credits, which is
a super neat TIL.&lt;&#x2F;p&gt;
&lt;p&gt;At the end of my clicking I quickly got side tracked by the requirement of an
IAM role to be use.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;the-humble-default-policy&quot;&gt;The humble default policy&lt;&#x2F;h2&gt;
&lt;p&gt;I feel like AWS knows IAM is pretty annoying when it provides you some
some defaults to copy &amp;amp; paste into a new role.&lt;&#x2F;p&gt;
&lt;p&gt;And here they are:&lt;&#x2F;p&gt;
&lt;h3 id=&quot;default-trust-policy&quot;&gt;Default trust policy&lt;&#x2F;h3&gt;
&lt;pre data-lang=&quot;json&quot; style=&quot;background-color:#f9f9f9;color:#111111;&quot; class=&quot;language-json &quot;&gt;&lt;code class=&quot;language-json&quot; data-lang=&quot;json&quot;&gt;&lt;span&gt;{
&lt;&#x2F;span&gt;&lt;span&gt;  &lt;&#x2F;span&gt;&lt;span style=&quot;color:#839c00;&quot;&gt;&amp;quot;Version&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#839c00;&quot;&gt;&amp;quot;2012-10-17&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;,
&lt;&#x2F;span&gt;&lt;span&gt;  &lt;&#x2F;span&gt;&lt;span style=&quot;color:#839c00;&quot;&gt;&amp;quot;Statement&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;: [
&lt;&#x2F;span&gt;&lt;span&gt;    {
&lt;&#x2F;span&gt;&lt;span&gt;      &lt;&#x2F;span&gt;&lt;span style=&quot;color:#839c00;&quot;&gt;&amp;quot;Effect&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#839c00;&quot;&gt;&amp;quot;Allow&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;,
&lt;&#x2F;span&gt;&lt;span&gt;      &lt;&#x2F;span&gt;&lt;span style=&quot;color:#839c00;&quot;&gt;&amp;quot;Principal&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;: {
&lt;&#x2F;span&gt;&lt;span&gt;        &lt;&#x2F;span&gt;&lt;span style=&quot;color:#839c00;&quot;&gt;&amp;quot;Service&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#839c00;&quot;&gt;&amp;quot;budgets.amazonaws.com&amp;quot;
&lt;&#x2F;span&gt;&lt;span&gt;      },
&lt;&#x2F;span&gt;&lt;span&gt;      &lt;&#x2F;span&gt;&lt;span style=&quot;color:#839c00;&quot;&gt;&amp;quot;Action&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#839c00;&quot;&gt;&amp;quot;sts:AssumeRole&amp;quot;
&lt;&#x2F;span&gt;&lt;span&gt;    }
&lt;&#x2F;span&gt;&lt;span&gt;  ]
&lt;&#x2F;span&gt;&lt;span&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;h3 id=&quot;default-permissions-policy&quot;&gt;Default permissions policy&lt;&#x2F;h3&gt;
&lt;pre data-lang=&quot;json&quot; style=&quot;background-color:#f9f9f9;color:#111111;&quot; class=&quot;language-json &quot;&gt;&lt;code class=&quot;language-json&quot; data-lang=&quot;json&quot;&gt;&lt;span&gt;{
&lt;&#x2F;span&gt;&lt;span&gt;  &lt;&#x2F;span&gt;&lt;span style=&quot;color:#839c00;&quot;&gt;&amp;quot;Version&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#839c00;&quot;&gt;&amp;quot;2012-10-17&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;,
&lt;&#x2F;span&gt;&lt;span&gt;  &lt;&#x2F;span&gt;&lt;span style=&quot;color:#839c00;&quot;&gt;&amp;quot;Statement&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;: [
&lt;&#x2F;span&gt;&lt;span&gt;    {
&lt;&#x2F;span&gt;&lt;span&gt;      &lt;&#x2F;span&gt;&lt;span style=&quot;color:#839c00;&quot;&gt;&amp;quot;Effect&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#839c00;&quot;&gt;&amp;quot;Allow&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;,
&lt;&#x2F;span&gt;&lt;span&gt;      &lt;&#x2F;span&gt;&lt;span style=&quot;color:#839c00;&quot;&gt;&amp;quot;Action&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;: [
&lt;&#x2F;span&gt;&lt;span&gt;        &lt;&#x2F;span&gt;&lt;span style=&quot;color:#839c00;&quot;&gt;&amp;quot;ec2:DescribeInstanceStatus&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;,
&lt;&#x2F;span&gt;&lt;span&gt;        &lt;&#x2F;span&gt;&lt;span style=&quot;color:#839c00;&quot;&gt;&amp;quot;ec2:StartInstances&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;,
&lt;&#x2F;span&gt;&lt;span&gt;        &lt;&#x2F;span&gt;&lt;span style=&quot;color:#839c00;&quot;&gt;&amp;quot;ec2:StopInstances&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;,
&lt;&#x2F;span&gt;&lt;span&gt;        &lt;&#x2F;span&gt;&lt;span style=&quot;color:#839c00;&quot;&gt;&amp;quot;iam:AttachGroupPolicy&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;,
&lt;&#x2F;span&gt;&lt;span&gt;        &lt;&#x2F;span&gt;&lt;span style=&quot;color:#839c00;&quot;&gt;&amp;quot;iam:AttachRolePolicy&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;,
&lt;&#x2F;span&gt;&lt;span&gt;        &lt;&#x2F;span&gt;&lt;span style=&quot;color:#839c00;&quot;&gt;&amp;quot;iam:AttachUserPolicy&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;,
&lt;&#x2F;span&gt;&lt;span&gt;        &lt;&#x2F;span&gt;&lt;span style=&quot;color:#839c00;&quot;&gt;&amp;quot;iam:DetachGroupPolicy&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;,
&lt;&#x2F;span&gt;&lt;span&gt;        &lt;&#x2F;span&gt;&lt;span style=&quot;color:#839c00;&quot;&gt;&amp;quot;iam:DetachRolePolicy&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;,
&lt;&#x2F;span&gt;&lt;span&gt;        &lt;&#x2F;span&gt;&lt;span style=&quot;color:#839c00;&quot;&gt;&amp;quot;iam:DetachUserPolicy&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;,
&lt;&#x2F;span&gt;&lt;span&gt;        &lt;&#x2F;span&gt;&lt;span style=&quot;color:#839c00;&quot;&gt;&amp;quot;organizations:AttachPolicy&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;,
&lt;&#x2F;span&gt;&lt;span&gt;        &lt;&#x2F;span&gt;&lt;span style=&quot;color:#839c00;&quot;&gt;&amp;quot;organizations:DetachPolicy&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;,
&lt;&#x2F;span&gt;&lt;span&gt;        &lt;&#x2F;span&gt;&lt;span style=&quot;color:#839c00;&quot;&gt;&amp;quot;rds:DescribeDBInstances&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;,
&lt;&#x2F;span&gt;&lt;span&gt;        &lt;&#x2F;span&gt;&lt;span style=&quot;color:#839c00;&quot;&gt;&amp;quot;rds:StartDBInstance&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;,
&lt;&#x2F;span&gt;&lt;span&gt;        &lt;&#x2F;span&gt;&lt;span style=&quot;color:#839c00;&quot;&gt;&amp;quot;rds:StopDBInstance&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;,
&lt;&#x2F;span&gt;&lt;span&gt;        &lt;&#x2F;span&gt;&lt;span style=&quot;color:#839c00;&quot;&gt;&amp;quot;ssm:StartAutomationExecution&amp;quot;
&lt;&#x2F;span&gt;&lt;span&gt;      ],
&lt;&#x2F;span&gt;&lt;span&gt;      &lt;&#x2F;span&gt;&lt;span style=&quot;color:#839c00;&quot;&gt;&amp;quot;Resource&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#839c00;&quot;&gt;&amp;quot;*&amp;quot;
&lt;&#x2F;span&gt;&lt;span&gt;    }
&lt;&#x2F;span&gt;&lt;span&gt;  ]
&lt;&#x2F;span&gt;&lt;span&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;h3 id=&quot;thoughts-on-these-policy&quot;&gt;Thoughts on these policy&lt;&#x2F;h3&gt;
&lt;p&gt;The permissions are pretty broad &amp;amp; could cause a lot of damage on their own.
Having the ability to attach policies to any of the three IAM principals is
screaming to be misused with some managed policies.&lt;&#x2F;p&gt;
&lt;p&gt;This policy is generated in the Console UI, so would be cool for them to tailor
the permissions to resources selected in the UI. Be a nice secure by default
option &amp;amp; leave the full example in the doc pages.&lt;&#x2F;p&gt;
&lt;p&gt;The saving grace is the trust policy only allowing the &lt;code&gt;budgets&lt;&#x2F;code&gt; service to use
the role.&lt;&#x2F;p&gt;
&lt;p&gt;That&#x27;s enough IAM nerd snipping, they have their reasons.&lt;&#x2F;p&gt;
&lt;h1 id=&quot;spy-vs-spy-time&quot;&gt;Spy vs. Spy time&lt;&#x2F;h1&gt;
&lt;p&gt;Like all good services in AWS that can mess with permissions, it might be good
to do some &lt;em&gt;threat modelling&lt;&#x2F;em&gt;.
Now, for todays session will be pitting against Red (Attackers) &amp;amp; Blue (Defenders) teams.&lt;&#x2F;p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;em&gt;(this is not just me typing with different coloured LED lighting, I swear)&lt;&#x2F;em&gt;&lt;&#x2F;p&gt;
&lt;&#x2F;blockquote&gt;
&lt;h2 id=&quot;setting-the-scene&quot;&gt;Setting the scene&lt;&#x2F;h2&gt;
&lt;p&gt;To set the scene for this cyber battle:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;Someone read the aforementioned AWS blog post &amp;amp; decided to give it a go, using the provided default role policies it worked &amp;amp; then went along their day&lt;&#x2F;li&gt;
&lt;li&gt;The Red team in their wizardy ways have managed to get the AWS credentials
of someone from Finance&#x27;s Budgeting team that is reasonable scoped to the
&lt;a rel=&quot;noopener nofollow noreferrer&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;glassechidna&#x2F;trackiam&#x2F;blob&#x2F;master&#x2F;policies&#x2F;AWSBudgetsActionsWithAWSResourceControlAccess.json&quot;&gt;&lt;code&gt;AWSBudgetsActionsWithAWSResourceControlAccess&lt;&#x2F;code&gt;&lt;&#x2F;a&gt; policy.&lt;&#x2F;li&gt;
&lt;li&gt;The Blue team are returning from their team lunch.&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;The Red Team has a few goals it is going for:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;Elevating their own privilege&lt;&#x2F;li&gt;
&lt;li&gt;Don&#x27;t let any one stop their rampage&lt;&#x2F;li&gt;
&lt;li&gt;Taking down &lt;em&gt;the site&lt;&#x2F;em&gt;&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;The Blue team wants none of that, but sometimes the best you can do is to know
something is about.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;red-team-are-going-in-with-the-attack&quot;&gt;Red team: are going in with the attack&lt;&#x2F;h2&gt;
&lt;p&gt;With their newly acquired Budget Team permissions they find scope at what they
can even do in the budget service. To their surprise they find this blog post
telling them exactly how to abuse these permissions!&lt;&#x2F;p&gt;
&lt;p&gt;Fortunately the budget service has this great way to apply IAM policies to
roles at events &amp;amp; SCPs to organization units (OU).&lt;&#x2F;p&gt;
&lt;h3 id=&quot;elevating-their-own-privilege&quot;&gt;Elevating their own privilege&lt;&#x2F;h3&gt;
&lt;p&gt;First things first, get more permissions. Red Team wants it &lt;strong&gt;ALL&lt;&#x2F;strong&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;Someone want to try out this new priv-esc (what the kewl h@ck0rz call it) they
saw using &lt;code&gt;budgets&lt;&#x2F;code&gt;. So they:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;Do the cloud &lt;code&gt;whoami&lt;&#x2F;code&gt; with the less succinct  &lt;code&gt;aws sys get-caller-identity&lt;&#x2F;code&gt;&lt;&#x2F;li&gt;
&lt;li&gt;Take stock, enumerate what permissions you got (there are some cool scripts
for this like &lt;a rel=&quot;noopener nofollow noreferrer&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;andresriancho&#x2F;enumerate-iam&quot;&gt;andresriancho&#x2F;enumerate-iam&lt;&#x2F;a&gt;)
&lt;ul&gt;
&lt;li&gt;the team learns they can list few things like IAM roles &amp;amp; EC2
&lt;ul&gt;
&lt;li&gt;most importantly, listing IAM Roles includes trust policies&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;&#x2F;li&gt;
&lt;li&gt;they also learn they got full access to &lt;code&gt;budgets&lt;&#x2F;code&gt;&lt;&#x2F;li&gt;
&lt;li&gt;they also discover the role setup for budget actions &amp;amp; left unused for years&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;Putting 1 and 1 together they came up with a plan of attack:&lt;&#x2F;p&gt;
&lt;ol&gt;
&lt;li&gt;Make a new budget that notifies at 1 S3 API call&lt;&#x2F;li&gt;
&lt;li&gt;Add a budget action to add the &lt;code&gt;AdministratorAccess&lt;&#x2F;code&gt; managed policy to their
IAM principal&lt;&#x2F;li&gt;
&lt;li&gt;???&lt;&#x2F;li&gt;
&lt;li&gt;Profit&lt;&#x2F;li&gt;
&lt;&#x2F;ol&gt;
&lt;p&gt;Not long after laying the trap it springs &amp;amp; they now got access to everything!&lt;&#x2F;p&gt;
&lt;p&gt;They are now free to do it all &amp;amp; order the &lt;a rel=&quot;noopener nofollow noreferrer&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;aws.amazon.com&#x2F;snowmobile&#x2F;&quot;&gt;Snowmobile&lt;&#x2F;a&gt; they always wanted.&lt;&#x2F;p&gt;
&lt;h3 id=&quot;continuing-the-rampage&quot;&gt;Continuing the rampage&lt;&#x2F;h3&gt;
&lt;p&gt;At this point it is pretty game over, but just to keep going until the Blue
Team notices &amp;amp; enjoying novelty of budget shinigans they keep going.&lt;&#x2F;p&gt;
&lt;p&gt;Next, on the list from the blog post: service control policies&lt;&#x2F;p&gt;
&lt;p&gt;So taking their previous knowledge, listing the SCPs in the account:&lt;&#x2F;p&gt;
&lt;ol&gt;
&lt;li&gt;Make a new budget that notifies at 1 S3 API call&lt;&#x2F;li&gt;
&lt;li&gt;Add a budget action to add the &lt;code&gt;DenyAll&lt;&#x2F;code&gt; SCP that just happened to all the OUs&lt;&#x2F;li&gt;
&lt;li&gt;???&lt;&#x2F;li&gt;
&lt;li&gt;No AWS services for anyone&lt;&#x2F;li&gt;
&lt;&#x2F;ol&gt;
&lt;blockquote&gt;
&lt;p&gt;It is worth noting that this will only work in the Organization root account&lt;&#x2F;p&gt;
&lt;&#x2F;blockquote&gt;
&lt;h3 id=&quot;take-down-the-site&quot;&gt;Take down the site&lt;&#x2F;h3&gt;
&lt;p&gt;I think there is starting to be a pattern here... but this time targeting EC2 &amp;amp;
RDS instances.&lt;&#x2F;p&gt;
&lt;h3 id=&quot;bonus-some-things-i-didn-t-try-cause-it-takes-a-billing-cycle&quot;&gt;BONUS: Some things I didn&#x27;t try cause it takes a billing cycle&lt;&#x2F;h3&gt;
&lt;p&gt;The docs say it may remove the policy that is added by the alert.&lt;&#x2F;p&gt;
&lt;p&gt;So what happens if you add a policy that was already added?!&lt;&#x2F;p&gt;
&lt;p&gt;For example, targeting the default SCP policy to allow all services. Will that just get removed
at the start of the next billing cycle.
I know from experience that if you remove that one out you just turn AWS control
plane off killing any serverless apps.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;blue-team-you-activated-my-trap-card&quot;&gt;Blue team: you activated my trap card!&lt;&#x2F;h2&gt;
&lt;p&gt;Since this service is behaving how it is suppose to &amp;amp; seems pretty legitimate it
is a bit hard to spot as it is happening. So I wouldn&#x27;t blame them to be
surprised when the Snowmobile shows up.&lt;&#x2F;p&gt;
&lt;p&gt;I doubt they&#x27;ll get caught with the same trick twice though, looking back there
are some tells that tell a tall tale.&lt;&#x2F;p&gt;
&lt;h3 id=&quot;monitoring-alerts&quot;&gt;Monitoring &amp;amp; Alerts&lt;&#x2F;h3&gt;
&lt;p&gt;There are a few places the Blue team can put some monitors &amp;amp; alerts on:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;events relating to a human permissions&lt;&#x2F;li&gt;
&lt;li&gt;events for attaching some juicy managed policies, like &lt;code&gt;AdministratorAccess&lt;&#x2F;code&gt; or
&lt;code&gt;IAMFullAccess&lt;&#x2F;code&gt;&lt;&#x2F;li&gt;
&lt;li&gt;if budget events are infrequently changed, any event related to their
change&lt;&#x2F;li&gt;
&lt;li&gt;or if you have a CI&#x2F;CD deploying the actions, monitor for actions not by the
CI&#x2F;CD&lt;&#x2F;li&gt;
&lt;li&gt;events for old roles suddenly coming back to life&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;This is not an exhaustive list but some starting points.&lt;&#x2F;p&gt;
&lt;p&gt;Also worth pointing out these do not need to be paged on. No one likes
noisy alerts, they&#x27;re often worse than nothing. So be careful tuning alerts.&lt;&#x2F;p&gt;
&lt;h3 id=&quot;cleaning-up-old-iam-roles&quot;&gt;Cleaning up old IAM roles&lt;&#x2F;h3&gt;
&lt;p&gt;The previous role left was the keystone of the Red team&#x27;s whole operation and
it is the same story with like 90% of lateral movement maneuvers in AWS.&lt;&#x2F;p&gt;
&lt;p&gt;Cleaning up old unused IAM roles is really important, you never really know&lt;&#x2F;p&gt;
&lt;blockquote&gt;
&lt;p&gt;The other 10% is over permissive IAM policies to make your own roles to
maneuver through.&lt;&#x2F;p&gt;
&lt;&#x2F;blockquote&gt;
&lt;h2 id=&quot;implicit-nice-parts&quot;&gt;Implicit nice parts&lt;&#x2F;h2&gt;
&lt;p&gt;By having to bring your own role (BYOR) for the service to use it does help mitigate
most of the potential of a Red Team&#x27;s fun with this new feature.&lt;&#x2F;p&gt;
&lt;h3 id=&quot;playing-by-your-own-rules&quot;&gt;Playing by your own rules&lt;&#x2F;h3&gt;
&lt;p&gt;First of all, your BYOR will be subject to your own SCPs in
your account. So if you already got good guardrails in your SCPs that prevent
silly things like attaching small managed policies like &lt;code&gt;AdministratorAccess&lt;&#x2F;code&gt;
to a role then you&#x27;ll be fine. If not, that might be a thing to look into.&lt;&#x2F;p&gt;
&lt;h3 id=&quot;it-doesn-t-have-aws-organization-magic&quot;&gt;It doesn&#x27;t have AWS Organization magic&lt;&#x2F;h3&gt;
&lt;p&gt;Currently there is no direct support from AWS Organization.
Which limits the scope that these can be applied on but does mean repetition
across a fleet of AWS accounts.&lt;&#x2F;p&gt;
&lt;p&gt;Though, on the plus side it also means you can&#x27;t pull an
Organization Cloudformation StackSet &amp;amp; make a service-linked role with
&lt;code&gt;AdministratorAccess&lt;&#x2F;code&gt; access all of the accounts with a click of a button
(&lt;em&gt;that is always a good time&lt;&#x2F;em&gt;).&lt;&#x2F;p&gt;
&lt;p&gt;If this ever does integrate with Organization, this feature will get added to the
&quot;why billing account access is scary list&quot;.&lt;&#x2F;p&gt;
&lt;h3 id=&quot;blast-radius&quot;&gt;Blast radius&lt;&#x2F;h3&gt;
&lt;p&gt;If the breach is not in the Organization root account, the damage is limited to
just that account. That&#x27;s with the assumption that accounts in a Organization stay
completed separated, which is pretty generous.&lt;&#x2F;p&gt;
&lt;h1 id=&quot;conclusion&quot;&gt;Conclusion&lt;&#x2F;h1&gt;
&lt;p&gt;As with most things AWS, the devil is in the IAM policy and what IAM Roles that
get left around.&lt;&#x2F;p&gt;
&lt;p&gt;There is nothing inherently wrong with this service or how it does about its
merry day, it is just in conjunction with people using AWS it can lead to a bad
time:tm:.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;my-takeaways&quot;&gt;My Takeaways&lt;&#x2F;h2&gt;
&lt;p&gt;Some of my takeaways from writing this:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;Unused IAM Roles can be dangerous: so clean up after yourself&lt;&#x2F;strong&gt;&lt;&#x2F;li&gt;
&lt;li&gt;&lt;strong&gt;Monitoring helps&lt;&#x2F;strong&gt;&lt;&#x2F;li&gt;
&lt;li&gt;&lt;strong&gt;Have guardrails around &lt;em&gt;juicy&lt;&#x2F;em&gt; managed IAM policies, it may save you
later on&lt;&#x2F;strong&gt;&lt;&#x2F;li&gt;
&lt;li&gt;&lt;strong&gt;New features in older services can lead to interesting paths to
&lt;code&gt;AdministratorAccess&lt;&#x2F;code&gt;, I would say read their announcement feeds but there
is too much so see if anyone makes a blog about it&lt;&#x2F;strong&gt;&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
</description>
      </item>
    </channel>
</rss>
